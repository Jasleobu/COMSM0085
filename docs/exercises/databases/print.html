<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>COMS10012 Databases Exercises</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="databases/1/sql-introduction.html"><strong aria-hidden="true">1.</strong> SQL introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/1/setup.html"><strong aria-hidden="true">1.1.</strong> Set up the database</a></li><li class="chapter-item expanded "><a href="databases/1/er-diagram.html"><strong aria-hidden="true">1.2.</strong> ER diagram</a></li></ol></li><li class="chapter-item expanded "><a href="databases/2/sql-beginners.html"><strong aria-hidden="true">2.</strong> SQL for beginners</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/2/explore-database.html"><strong aria-hidden="true">2.1.</strong> Explore the database</a></li><li class="chapter-item expanded "><a href="databases/2/elections.html"><strong aria-hidden="true">2.2.</strong> Bristol elections</a></li><li class="chapter-item expanded "><a href="databases/2/census.html"><strong aria-hidden="true">2.3.</strong> The UK census</a></li></ol></li><li class="chapter-item expanded "><a href="databases/3/sql-intermediate.html"><strong aria-hidden="true">3.</strong> Intermediate SQL</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/3/exercises.html"><strong aria-hidden="true">3.1.</strong> Exercises</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">COMS10012 Databases Exercises</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#introduction-to-sql" id="introduction-to-sql">Introduction to SQL</a></h1>
<p>This is the first of four activities to teach you relational databases and the SQL programming language.</p>
<h2><a class="header" href="#videos" id="videos">Videos</a></h2>
<p>The videos for this activity are:</p>
<table><thead><tr><th>Video</th><th align="right">Length</th><th>Mediasite Link</th></tr></thead><tbody>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/429083c5-b684-4d31-9b8b-44a8cd235423.mp4/QualityLevels(699000)">Installing MariaDB</a></td><td align="right">24 minutes, optional</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/2a24bf2b1190463391295aeb8adc392b1d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/ad6c51a3-c7ee-4143-875c-7b400815c61d.mp4/QualityLevels(699000)">Introduction to Relational Modelling 1</a></td><td align="right">30 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/43f44fe7c4c3422cbf7faddfa68cebd11d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/aaaf526a-eb05-44d8-b25f-55fa121ef494.mp4/QualityLevels(699000)">Introduction to Relational Modelling 2</a></td><td align="right">7 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/dd89be0cabbe409ebda7755f8a8ec8cf1d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/54d63f28-708e-406d-a774-45570ca38e88.mp4/QualityLevels(699000)">SQL Create-Drop Scripts</a></td><td align="right">26 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/11542b725bf64dbca856056c705a22261d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/b71c5518-25fb-4b94-920d-293bef725846.mp4/QualityLevels(699000)">SQL SELECT</a></td><td align="right">11 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/bdbc27f3871e4555b324b8766d3426711d">mediasite link</a></td></tr>
</tbody></table>
<p>The first video is optional but should help you if you are having problems installing MariaDB on Alpine linux.</p>
<h2><a class="header" href="#exercises" id="exercises">Exercises</a></h2>
<ul>
<li><a href="databases/1/./setup.html">Set up the database</a></li>
<li><a href="databases/1/./er-diagram.html">ER diagrams</a></li>
</ul>
<h1><a class="header" href="#set-up-the-database" id="set-up-the-database">Set up the database</a></h1>
<h2><a class="header" href="#history" id="history">History</a></h2>
<p>In this unit, we will be using the free database MariaDB, which is a clone of MySQL and was written by the same author - Michael &quot;Monty&quot; Widenius, from Finland. The history behind the naming is that Monty first created MySQL (named after his daughter, My) which became the most popular open-source database. He sold MySQL to Sun, who were in turn bought by Oracle - who are famous for their commercial database software. As a result, Monty created a clone of MySQL called MariaDB (named after his other daughter). MySQL and MariaDB are compatible in many ways and most of what we learn on this unit will apply equally to both of them, although both Oracle (for MySQL) and the open-source community (for MariaDB) have added new features to their databases.</p>
<p>Although we will be using MariaDB, in some places the name MySQL will still appear - most notably as the name of the command-line program that you use to access the database.</p>
<h2><a class="header" href="#install-the-database" id="install-the-database">Install the database</a></h2>
<p>Open the Alpine virtual machine and install the database with</p>
<pre><code class="language-sh">$ sudo apk add mariadb mariadb-client
</code></pre>
<p>The <code>mariadb</code> package contains the server that stores the data and lets clients log in. <code>mariadb-client</code> is a command-line client (with the command name <code>mysql</code>); later on we will also use a Java client to access a database from a Java application.</p>
<p>The database server is now installed, but we still need to create a database:</p>
<pre><code class="language-sh">$ sudo /etc/init.d/mariadb setup
</code></pre>
<p>Files in <code>/etc/init.d</code> are service scripts; services are commands that can be started automatically when the machine starts and often run in the background - in this case the mariadb service runs the server so that clients can connect to it. We had to use the full path as the <code>/etc/init.d</code> folder is not normally in your PATH variable, as it's mostly used by the system rather than directly by users. We are manually calling the service's <code>setup</code> command to create the database - if you look inside the service script, you'll see that it calls the <code>mariadb_install_db</code> program to create a database in <code>/var/lib/mysql</code>. This path is not writable for normal users, so we need sudo on this command.</p>
<p>If you read the output of this command, you will see a warning about security. This is important and we will come back to it.</p>
<p>We now have a database, but the server is not running yet. We can start it for now with</p>
<pre><code class="language-sh">$ sudo rc-service mariadb start
</code></pre>
<p>Check that the service is running with</p>
<pre><code class="language-sh">$ rc-status
</code></pre>
<p>This should show <code>mariadb [ started ]</code> somewhere at the bottom under the &quot;manual&quot; runlevel. This means we've started the server, but it won't start automatically next time we restart the machine. Let's change that:</p>
<pre><code class="language-sh">$ sudo rc-update add mariadb default
</code></pre>
<p>This adds the mariadb service to the &quot;default&quot; runlevel, which is for things that you want to start when the machine starts. For example, the ssh service is already here otherwise you would not be able to log in to the machine with <code>vagrant ssh</code> at all. Check with another <code>rc-status</code> that mariadb is still running, but now listed under &quot;default&quot;.</p>
<h2><a class="header" href="#security" id="security">Security</a></h2>
<p>You now have a running database and you can log in with <code>mysql</code>. However, the database will allow anyone to log in and change anything, which is not what you want - especially not on a production machine.</p>
<p>Most distributions come with a <code>mysql_secure_installation</code> script that prompts you for a database root password and sets up accounts. We are going to do a similar thing, but with a custom setup for our purposes.</p>
<ul>
<li>Run <code>mysql -u root</code>. This should log you in as root without any authentication, which explains why I am making such a fuss about security! Quit again by typing Control+D.</li>
<li>Run <code>mysql -u root -e 'source /vagrant/secure-setup.sql</code>. The <code>-e</code> command means &quot;run the following command line argument as a script&quot;, as you know already from sed and several other tools; <code>source</code> means &quot;load a file and run it&quot; and the file in question is part of the lab package I have prepared for you.</li>
<li>Run <code>mysql -u root</code> again. This time, it will not let you in, which is what we want.</li>
</ul>
<p>The secure-setup script is as follows:</p>
<pre><code class="language-sql">UPDATE mysql.user SET Password=PASSWORD('BA/458cR-5p.') WHERE User='root';
DELETE FROM mysql.user WHERE User='';
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
DROP DATABASE IF EXISTS test;
DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
FLUSH PRIVILEGES;
</code></pre>
<p>The first line sets a root password, and also shows the absolute minimum standard for a password: 12 characters, mix of uppercase, lowercase and symbols, random-ish. This is the password that you will be using to log in as root to your database on the VM, but of course you can change it if you want to.</p>
<ul>
<li>Type <code>mysql -u root -p</code> on the command line and press Enter. <code>-p</code> means &quot;if a password is needed, prompt for one&quot;. You will be asked for the root password, type it in (without the quotes) and you should be let back in to the database. Once you are in, if you'd like to, you can use the first command from the secure-setup script to set a new password of your own.</li>
</ul>
<p>The next two lines remove some default users: one with the empty username, and all versions of root that let you log in over the network. The only versions of root that still exist are now &quot;localhost&quot; (e.g. from the same machine), 127.0.0.1 (same thing but using IPV4 notation) and &quot;::1&quot; (same in IPv6). This means that now, if your VM is connected to the internet, you cannot log in as root remotely at all, even with the password, which is the correct attitude to security. To administer a database, you should always first log in to the machine via ssh using a key file, then log in to the database from the machine itself.</p>
<p>Next in the setup script, we remove the default test database and user.</p>
<p>Finally, <code>FLUSH PRIVILEGES</code> updates the in-memory cache of the users table, making your new permissions take effect.</p>
<p>Note: what happens when you install the mariadb package (or install it from a ZIP file) depends on the distribution. For some distributions, installing the package automatically creates a database, and adds the server to the default runlevel. Alpine will not do any of these things for you - you have to configure it itself, which is a good opportunity to learn what's going on behind the scenes in other distributions. Most distributions will not, however, configure the security settings automatically - some of them prompt for a root password at installation, but typically leave the test database and let root login remotely. Wherever you install mariadb or mysql, please check this yourself - an unsecured database is something that hackers will be keeping an eye out for.</p>
<h2><a class="header" href="#importing-sample-data" id="importing-sample-data">Importing sample data</a></h2>
<p>I have prepared some sample data that we will be using in this and the following weeks.</p>
<p>First, download the following three files and place them in the same folder as your Vagrantfile. You can do this for example with <code>wget ADDRESS</code> in Alpine linux; <code>wget</code> is a download program.</p>
<pre><code>https://cs-uob.github.io/COMS10012/resources/databases/sample-data.sql
https://cs-uob.github.io/COMS10012/resources/databases/secure-setup.sql
https://cs-uob.github.io/COMS10012/resources/databases/sampledata.tar
</code></pre>
<p>If you are using a local copy of this repository, you can find the files under <code>/resources/databases</code>.</p>
<p>The <code>tar</code> file is a <em>tape archive</em>: a file that contains further files and folders, as if it were a folder itself. Extract it by going to <code>/vagrant</code> in Alpine and run</p>
<pre><code>tar xvf sampledata.tar
</code></pre>
<p>This creates a folder sampledata with the files we need.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Note that <code>tar</code> uses an older convention where options are not prefixed with a dash; the options here are x=extract a file, v=verify (print the name of every processed file to standard output), f=the filename is in the following argument.</p>
<p>To create a tar file yourself, the command would be <code>tar cvf ARCHIVE.tar FILE1 FILE2...</code> where c=create the archive if it doesn't exist, and assume all arguments not consumed by another flag refer to files to be added. In fact, <code>tar xvf ARCHIVE.tar FILES...</code> also works and only extracts the named files from the archive.</p>
</div>
</div>
<p>Load the sample data with the following command, which will ask for your root password:</p>
<pre><code class="language-sh">$ mysql -u root -p -e &quot;source /vagrant/sample-data.sql&quot;
</code></pre>
<p>This pulls in some data in CSV files (have a look at the script if you want) and creates a default user &quot;vagrant&quot; who can log in to the database without a password, but can only read and not write the two sample databases &quot;census&quot; and &quot;elections&quot;. There is another database called &quot;data&quot; which starts out empty, and &quot;vagrant&quot; can both read and write it.</p>
<p>You can now log in to the database and try the following:</p>
<ul>
<li><code>mysql</code> on its own logs you in, you now get the database prompt <code>MariaDB [(none)]&gt;</code> to show that you haven't loaded a particular database yet.</li>
<li><code>SHOW DATABASES;</code> on the database prompt gives you a list of databases which you have access too.</li>
<li>Select one with the USE command, for example <code>USE elections;</code>. Your prompt should now read <code>MariaDB [elections]&gt;</code>.</li>
<li><code>SHOW TABLES;</code> will show the tables in the selected database.</li>
<li>There's a Party table in the elections database, so <code>SELECT * FROM Party;</code> will show you the data.</li>
<li>You could also use <code>DESCRIBE Party;</code> to show a list of columns and types in the Party table.</li>
<li>Finally, <code>exit</code> or Control+D on a line of its own gets you back to the shell.</li>
</ul>
<p>You can open the SQL and CSV files under <code>/vagrant/sampledata</code> to compare with the output you get from MariaDB. Study this until it makes sense to you. The <code>setup.sql</code> files contain the database schemas and the <code>import.sql</code> ones pull in the sample data.</p>
<h2><a class="header" href="#on-a-lab-machine" id="on-a-lab-machine">On a lab machine</a></h2>
<p>On a lab machine, to save disk space your VMs may not remain between reboots - and because they are not hosted on the network file system, if you log in to a different machine next time, your changes will not be saved either but you will get the VM reinstalled from scratch. To make sure the database is ready whenever you need it, open the <code>Vagrantfile</code> in a text editor and make the following changes.</p>
<ul>
<li>On the line starting <code>apk add</code>, add the packages <code>mariadb</code> and <code>mariadb-client</code> to the end, separated by spaces.</li>
<li>Download and save the three setup files (<code>sample-data.sql</code>, <code>secure-setup.sql</code> and <code>sampledata.tar</code>) in the same folder as your Vagrantfile (this is on the host machine, so it will not get deleted along with the VM).</li>
<li>Extract the tar file so that there is a folder <code>sampledata/</code> in the same folder as your Vagrantfile.</li>
<li>Following the <code>apk add</code> line in your Vagrantfile, add the following lines:</li>
</ul>
<pre><code class="language-sh">/etc/init.d/mariadb setup
rc-update add mariadb default
rc-service mariadb start
mysql â€“u root â€“e 'source /vagrant/sample-data.sql'
mysql â€“u root â€“e 'source /vagrant/secure-setup.sql'
</code></pre>
<p>This ensures that whenever vagrant recreates the VM, it installs the database for us. The commands are basically the ones that we have done just now, except that we source the sample data before running the secure setup. This is so that the sample data command does not need a password, as none has been set so far - that only happens during the secure setup command.</p>
<h1><a class="header" href="#reading-an-er-diagram" id="reading-an-er-diagram">Reading an ER diagram</a></h1>
<p>Here is an ER diagram for a fictional university database:</p>
<p><img src="databases/1/../img/uni-diagram.png" alt="ER diagram" /></p>
<p>The foreign key columns are not included in the tables - in this diagram, they are implied by the relationships, e.g. the <code>Unit.director</code> column comes from the &quot;directs&quot; relationship.</p>
<p>Looking at the diagram and the table schemas, answer the following questions for yourself:</p>
<ul>
<li>Which relationships are mandatory or optional? (For example, must every unit have at least one student enrolled?)</li>
<li>Which relationships are one-one, one-many or many-many?</li>
<li>How do the above affect the placement of foreign keys? For example, why is the foreign key for &quot;lecturer belongs to research group&quot; on the Lecturer table?</li>
</ul>
<h1><a class="header" href="#drawing-an-er-diagram" id="drawing-an-er-diagram">Drawing an ER diagram</a></h1>
<p>Draw an ER diagram for the following scenario.</p>
<blockquote>
<p>The University of Bristol Hoverboard Society (HovSoc) wants to create a database to manage its membership and events. Each member has a name, an optional student number, a contact e-mail address and a hoverboard riding skill level (represented as an integer, minimum 0). We assume that e-mail addresses are unique among members.</p>
<p>The committee consists of some of the members, each of which has a unique committee role. We assume that committee roles do not change during the year and that each committee role must be filled every year.</p>
<p>An event has a date, a name, a location, an optional description and an organiser who must be a society member (not necessarily a committee member). An event is attended by a set of members. There is never more than one event at the same location on the same date but event names are not unique.</p>
</blockquote>
<p>You can draw the diagram with pen and paper or you can use a free modelling tool like <a href="databases/1/draw.io">draw.io</a>. </p>
<ul>
<li>For draw.io, open the &quot;Entity Relation&quot; section in the menu on the left and use the &quot;Table&quot; (first item) object for tables. Clicking on it adds a table to your diagram.</li>
<li>To add a row to a table, select an existing row and press Control-D (duplicate item). To delete a row, press the delete key.</li>
<li>To add a relationship, select a table by clicking its header and drag one of the blue triangles that appear round the edges onto another table. You can change the type of a relationship in the details panel on the right (the &quot;line start&quot; and &quot;line end&quot; boxes).</li>
<li>File/Save as lets you download your diagram in an XML-based format, which you can open and edit later. File/Export as lets you download it as an image.</li>
</ul>
<h1><a class="header" href="#implementing-a-schema" id="implementing-a-schema">Implementing a Schema</a></h1>
<p>Write a CREATE/DROP script for the schema that you have just designed.</p>
<ul>
<li>A create/drop script starts with a sequence of DROP TABLE IF EXISTS statements followed by a sequence of CREATE TABLE scripts. The effect of running it is to make sure all tables exist and are empty, whether or not the tables existed before.</li>
<li>If table A has a foreign key to table B then you must create table B before A and drop table A before dropping B. The simple way to do this is work out the CREATE order, then put all DROP statements in the exact opposite order.</li>
</ul>
<p>Save your script as a file (the extension <code>.sql</code> is usual for SQL scripts).</p>
<p>To test that it works, log in to the database with <code>mysql</code> on the command line in the lab machine, from a terminal in the same folder as your create/drop script. Then run the command</p>
<pre><code>USE data;
</code></pre>
<p>to select the (initially empty) database called <code>data</code>, on which you have read and write permissions. Note that there is a semicolon at the end.</p>
<p>As long as you started your MariaDB session in the folder with your script, you can now run the command <code>\. SCRTIPNAME.SQL</code>, that is a backslash, a period, a space and then the name of the script. As this is a command directly for the MariaDB client rather than a command to be run on the server, it does not take a semicolon.</p>
<p>If you get any errors, then <code>SHOW ERRORS;</code> will display more information. If not, check with <code>SHOW TABLES;</code> that your tables exist.</p>
<p>Now, run the script a second time. If the order of all commands is correct, then it should run through again without errors.</p>
<h1><a class="header" href="#sql-for-beginners" id="sql-for-beginners">SQL for beginners</a></h1>
<p>This is the second activity of four to teach you relational databases and the SQL programming language.</p>
<h2><a class="header" href="#videos-1" id="videos-1">Videos</a></h2>
<p>The videos for this activity are:</p>
<table><thead><tr><th>Video</th><th align="right">Length</th><th>Mediasite Link</th></tr></thead><tbody>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/bab37acb-e69a-4718-8ba8-a2dceee71a99.mp4/QualityLevels(699000)">SQL JOIN, part 1</a></td><td align="right">10 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/87fc5f25f4d446f99149a58289899e8d1d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/ab90d187-69b6-43fa-a9ed-3a9a9ea0a3b3.mp4/QualityLevels(699000)">SQL JOIN, part 2</a></td><td align="right">10 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/26c1ecb043034568987acc2d3eedc8371d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/f050a7fb-3341-44ab-84f0-59268215ed70.mp4/QualityLevels(699000)">SQL ORDER BY</a></td><td align="right">9 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/135220e25bf542099703ca40a900722e1d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/d68cd782-7813-4280-b650-6111bed23469.mp4/QualityLevels(699000)">Normal Forms</a></td><td align="right">56 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/6a2edd198312428e846371a3bfd0625c1d">mediasite link</a></td></tr>
</tbody></table>
<p>The normal forms one continues where the introduction to relational modelling left off. It is a long but connected piece of content (1 hour) that you will probably want to watch pieces of several times.</p>
<h2><a class="header" href="#exercises-1" id="exercises-1">Exercises</a></h2>
<ul>
<li><a href="databases/2/./explore-database.html">Explore the database</a></li>
<li><a href="databases/2/./elections.html">Bristol elections</a></li>
<li><a href="databases/2/./census.html">The UK census</a></li>
</ul>
<h1><a class="header" href="#explore-the-database" id="explore-the-database">Explore the database</a></h1>
<p>Open the virtual machine and type <code>mysql</code>. Assuming you have installed the database correctly as in the previous activity, you should see the prompt <code>MariaDB [(none)]&gt;</code> which shows that you are connected to a database server but you have not selected a database yet.</p>
<p>Have a look at the databases that exist with the command</p>
<pre><code>SHOW DATABASES;
</code></pre>
<p>Like all SQL commands, it needs a semicolon at the end. You should see four databases including <code>census</code> and <code>elections</code>. Let's select one of them:</p>
<pre><code>USE elections;
</code></pre>
<p>SQL keywords like <code>USE</code> are not case-sensitive, but it is convention to write them in all upper case. SQL names of tables, columns etc. like <code>elections</code> however are case-sensitive. Your prompt should now show <code>MariaDB [elections]&gt;</code>.</p>
<p>Have a look at the tables in this database with</p>
<pre><code>SHOW TABLES;
</code></pre>
<p>You should see <code>Candidate</code>, <code>Party</code> and <code>Ward</code>. Let's have a look at one:</p>
<pre><code>DESCRIBE Candidate;
</code></pre>
<p>The output will look like this:</p>
<pre><code>+-------+--------------+------+-----+---------+----------------+
| Field | Type         | Null | Key | Default | Extra          |
+-------+--------------+------+-----+---------+----------------+
| id    | int(11)      | NO   | PRI | NULL    | auto_increment |
| name  | varchar(100) | NO   | UNI | NULL    |                |
| party | int(11)      | YES  | MUL | NULL    |                |
| ward  | int(11)      | YES  | MUL | NULL    |                |
| votes | int(11)      | YES  |     | NULL    |                |
+-------+--------------+------+-----+---------+----------------+
</code></pre>
<p>The first two columns tell you the names and types of columns in this table. The third column (Null) tells you if NULL values are allowed in this column. The Key column tells us that id is the primary key (PRI), name has a unique constraint (UNI), party and ward are foreign keys (MUL) and there are no key constraints at all on votes.</p>
<p>For even more information, try this:</p>
<pre><code>SHOW CREATE TABLE Candidate;
</code></pre>
<p>The output is a bit messy but it shows you (more or less) the statement used to create the table. From here we can read off the details of the foreign keys:</p>
<pre><code>CONSTRAINT `Candidate_ibfk_1` FOREIGN KEY (`party`) REFERENCES `Party` (`id`)
CONSTRAINT `Candidate_ibfk_2` FOREIGN KEY (`ward`) REFERENCES `Ward` (`id`)
</code></pre>
<p>So the <code>party</code> column is a foreign key pointing at the <code>id</code> column in the <code>Party</code> table.</p>
<p>Now let's look at some data. This command shows you all entries in the Candidate table:</p>
<pre><code>SELECT * FROM Candidate;
</code></pre>
<p>There are 141 entries. Looking at the first one:</p>
<pre><code>+-----+--------------------------------+-------+------+-------+
| id  | name                           | party | ward | votes |
+-----+--------------------------------+-------+------+-------+
|   1 | Patrick Dorian Hulme           |     1 |    1 |    16 |
</code></pre>
<p>The party and ward ids on their own don't tell us much, but as they are foreign keys we can use them to join on the tables that do contain this information:</p>
<pre><code>SELECT * FROM Candidate
INNER JOIN Party ON Party.id = Candidate.party
INNER JOIN Ward ON Ward.id = Candidate.ward;
</code></pre>
<p>On the MariaDB prompt, if you don't end with a semicolon then the program assumes you want to type a command over multiple lines, and shows the continuation prompt <code>-&gt;</code> for the next ones. This also allows you to copy-paste multi-line commands from a text editor into the MariaDB client. Ending a line with a semicolon executes the query and drops you back to the main prompt.</p>
<p>You will now see a much longer listing, starting like this (I have shortened some columns):</p>
<pre><code>+-----+----------------------+-------+------+-------+----+--------------+----+-----------+------------+
| id  | name                 | party | ward | votes | id | name         | id | name      | electorate |
+-----+----------------------+-------+------+-------+----+--------------+----+-----------+------------+
|   7 | Matthew Simon Melias |     7 |    1 |  1067 |  7 | Conservative |  1 | Avonmouth |       9185 |
</code></pre>
<p>The first thing to note is that the results are no longer in the same order: P. D. Hulme is no longer at the top. Unless you tell the database that you want a particular order, it is allowed to choose its own one and depending on what joins you do, this might change.</p>
<p>There are several columns here named id, one from each of the tables - in general, doing <code>SELECT *</code> on a joined table gets you more data than you need.
This would be a nicer query unless you're actially interested in the ids:</p>
<pre><code>SELECT Candidate.name AS name,
Party.name AS party,
Ward.name AS ward,
votes,
electorate
FROM Candidate
INNER JOIN Party ON Party.id = Candidate.party
INNER JOIN Ward ON Ward.id = Candidate.ward;
</code></pre>
<p>Here is the start of the output that I get:</p>
<pre><code>+----------------------+--------------+-----------+-------+------------+
| name                 | party        | ward      | votes | electorate |
+----------------------+--------------+-----------+-------+------------+
| Matthew Simon Melias | Conservative | Avonmouth |  1067 |       9185 |
</code></pre>
<p>Explore the elections database a bit to get a feel for how the data is structured.
For example, what party and ward did Patrick Dorian Hulme from above stand for?
What is the schema of the elections database - you might want to draw a diagram?</p>
<h1><a class="header" href="#bristol-elections" id="bristol-elections">Bristol elections</a></h1>
<p>In 2014, Bristol held council elections for 24 of its wards. Each ward elected one councillor to represent the ward on the city council. The results are in the <code>elections</code> database, with the following schema as you have hopefully just discovered:</p>
<p><img src="databases/2/../img/elections.png" alt="elections ER diagram" /></p>
<p>From an ER diagram you can derive a <em>JOIN strategy</em>, a way of representing all the useful information in a database. For individual queries, you may only need a subset of this information so you can leave off unnecessary parts of the full JOIN strategy. In this case, the following would work:</p>
<pre><code>SELECT Candidate.name AS name, Party.name AS party, Ward.name AS ward, Candidate.votes, Ward.electorate
FROM Candidate 
INNER JOIN Party ON Candidate.party = Party.id
INNER JOIN Ward ON Candidate.ward = Ward.id
</code></pre>
<h2><a class="header" href="#exercises-2" id="exercises-2">Exercises</a></h2>
<p>Find SQL statements to answer the following questions. Your answer to each question should be a single query, and you should not hard-code any ids. For example, if a question is about the Labour party, you should use the string <code>'Labour'</code> in your query somewhere, not look up the party id and hard-code that in your query.</p>
<p>Although you can answer all the exercises in this section by taking the join strategy and adding clauses where necessary, there is sometimes a quicker way. But if you don't know where to start, consider how you would extract the result you want from the joined table. The WHERE clause determines which rows appear in the result and the SELECT clause picks the columns that appear in the result.</p>
<ol>
<li>List the names of all parties that stood in the election, ordered alphabetically by name.</li>
<li>List the names of all parties that stood in the Bedminster ward.</li>
<li>How many votes did Labour get in the Stockwood ward?</li>
<li>List the names, parties and number of votes obtained for all candidates in the Southville ward. Order the candidates by number of votes obtained descending (winner comes first).</li>
<li>List the name, party and number of votes obtained for the winner only in the Knowle ward. <em>(Hint: apart from changing the ward name, you only need one small modification to the statement from the last question. You may assume no ties.)</em></li>
</ol>
<h1><a class="header" href="#the-2011-uk-census" id="the-2011-uk-census">The 2011 UK Census</a></h1>
<p>In 2011, the UK took a census of all households. We will look at the data for one particular question: &quot;KS608 Occupation&quot;.</p>
<h2><a class="header" href="#background-uk-geography" id="background-uk-geography">Background: UK Geography</a></h2>
<p>The United Kingdom of Great Britain and Northern Ireland (UK) is a country that contains the individual countries England, Wales, Scotland (at the time of writing) and Northern Ireland (but not the Republic of Ireland). The census data for this question comes from the Office of National Statistics (ONS) which is for England and Wales only. Scotland and Northern Ireland have separate statistical offices.</p>
<p>England itself can be divided into 9 regions: </p>
<ul>
<li>The North West</li>
<li>Yorkshire and The Humber</li>
<li>The North East</li>
<li>The West Midlands</li>
<li>The East Midlands</li>
<li>The South West</li>
<li>The East</li>
<li>The South East</li>
<li>London</li>
</ul>
<p>The UK used to be further divided into counties but these are much less important nowadays. In fact there is a mix of counties, unitary authorities and boroughs - 152 in total. These are all called &quot;county-level units&quot; (CLUs).</p>
<p>The smallest relevant unit for political and statistical purposes is the electoral ward, often simply called ward. Wards elect their own councillors (as we have seen) and national statistics are available at a ward level. There were 8570 wards at the time of the 2011 census. For example, the City of Bristol unitary authority contained 35 wards, of which the University of Bristol was in the Cabot ward.</p>
<p>Each statistical unit (ward, county, unitary authority etc.) is assigned a 9-character code by the ONS of the form <code>Xaabbbbbb</code> where X is E for England and W for Wales. The first two digits <code>aa</code> identify the type of unit: 05 is a ward, 06 a unitary authority; in England only E12 is a region, E08 is a borough (metropolitan), E09 is a borough of London and E10 is a county. The last 6 digits identify the individual unit. Finally, the codes for all of England and Wales are E92000001 and W92000004. </p>
<p>An interactive online map of the statistical units of the UK is available online at <a href="http://ukdataexplorer.com/census/">UK data explorer</a> or <a href="https://datashine.org.uk">DataShine</a>. All census data for individual questions is publicly available. (The most interesting data - correlations between questions - is not all openly available due to privacy issues. Researchers can apply to the ONS to get access to particular data sets.)</p>
<h2><a class="header" href="#data-format" id="data-format">Data format</a></h2>
<p>The <code>census</code> database has the following schema.</p>
<p><img src="databases/2/../img/census.png" alt="census ER diagram" /></p>
<p>For wards in England, the <code>parent</code> FK points at the county table and identifies the CLU (county-level unit) to which the ward belongs. For wards in Wales, the <code>Ward.parent</code> column is <code>NULL</code> which you need to take into account when working out a JOIN strategy.</p>
<h2><a class="header" href="#ks608-occupation" id="ks608-occupation">KS608: Occupation</a></h2>
<p>Question KS608 on the 2011 census asked all UK citizens in employment and between the ages of 16 and 74 to classify themselves as one of 9 occupation classes.</p>
<ul>
<li>Have a look at the <code>Occupation</code> table in the <code>census</code> database to see the 9 occupation classes.</li>
</ul>
<p>The answers to the question are recorded in the <code>Statistic</code> table in the following format. Gender is 1 for women an 0 for men; in the 2011 census these where the only gender options.</p>
<pre><code>+-----------+-------+--------+------+
| wardId    | occId | gender | data |
+-----------+-------+--------+------+
| E05000001 |     1 |      1 |   54 |
+-----------+-------+--------+------+
</code></pre>
<p>This row records that in ward <code>E05000001</code> (Aldersgate), 54 women (gender=1) said that they worked as &quot;Managers, directors and senior officials&quot; (occId=1).</p>
<p>Note how (in the ER diagram) the primary key of the Statistic table is a composite of three columns (wardId, occId, gender). This is exactly what you would expect in a table that has one data value per ward, occupation class and gender.</p>
<h2><a class="header" href="#exercises-3" id="exercises-3">Exercises</a></h2>
<ol>
<li>The university of Bristol is situated in the <code>Cabot</code> ward (ward names are not always distinct, but this one is). Find the names and codes of the CLU, region and country containing the Cabot ward (CLU = county level unit = &quot;row in County table&quot;).</li>
<li>If you used multiple SQL queries for the last question, do it in one single query now. (In other words, find a join strategy for the tables you need.)</li>
<li>Find the number of women in occupation class 1 (managers etc.) in the Cabot ward. You may use ward code for Cabot that you found in the first query and the occupation id 1 directly - you do not need any JOINs for this query.</li>
<li>For the Stoke Bishop ward (E05002003), list the 9 occupation class names and the number of men in each occupation. Your table should have two columns called <code>name</code> and <code>number</code>. You can use the provided ward code, you do not need to join on the ward name.</li>
</ol>
<p>We will soon be able to do more interesting statistical queries on the census data but for that we need SQL's statistical functions which we will learn next week.</p>
<p>Here's a slightly more tricky question to finish off with. It can be done with only the techniques that we have learnt so far.</p>
<ul>
<li>Find all ward names that are not unique, and print them in alphabetical order (only once each).</li>
</ul>
<p><em>There are 400 distinct such names in total (for example, there are 21 wards called 'Abbey') so your query will produce quite a long table. Your query might also take a while to execute, there are faster ways to do this but not with the material we've learnt so far. The table starts &quot;Abbey, Alexandra, All Saints&quot; and ends &quot;Worsley, Wyke, Yarborough&quot;.</em></p>
<h1><a class="header" href="#intermediate-sql" id="intermediate-sql">Intermediate SQL</a></h1>
<p>This is the third of four activities to teach you relational databases and SQL.</p>
<h2><a class="header" href="#videos-2" id="videos-2">Videos</a></h2>
<p>The videos for this activity are:</p>
<table><thead><tr><th>Video</th><th align="right">Length</th><th>Mediasite Link</th></tr></thead><tbody>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/f477bbcf-dbc3-4ca3-b684-679df2b7bfae.mp4/QualityLevels(698000)">SQL subqueries</a></td><td align="right">13 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/8b40ddf3273c4d4684a17a0d915b9fba1d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/abdfca9a-7cc2-489e-ab55-bf4033a89ee2.mp4/QualityLevels(698000)">SQL statistics</a>)</td><td align="right">22 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/deb1e6b1bf0542ebaabf0b60849e1a181d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/48f9ce6e-ae99-47e3-9e7f-2a91f7fd4f11.mp4/QualityLevels(698000)">SQL NULL</a></td><td align="right">7 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/2530533262754ce0a05e801f45562be41d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/7e570b3a-50d1-4547-8c31-bc6df22f43b3.mp4/QualityLevels(698000)">SQL tips</a></td><td align="right">17 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/df78631257674700916b7bc94ba67ea31d">mediasite link</a></td></tr>
</tbody></table>
<h2><a class="header" href="#exercises-4" id="exercises-4">Exercises</a></h2>
<p>The exercises for this activity are all on one page:</p>
<ul>
<li><a href="databases/3/./exercises.html">Intermediate SQL</a></li>
</ul>
<h1><a class="header" href="#census-and-elections-exercises" id="census-and-elections-exercises">Census and elections exercises</a></h1>
<p>Here are some more advanced exercises based on the census and elections schemas from the last activity.</p>
<p>Your answer to each question should be a single SQL query, that is one semicolon at the end. JOINs, subqueries, WITH clauses etc. are allowed of course.
Where an identifier is given in the question you may use it, e.g. when I say &quot;the Cabot ward (E05001979)&quot; you can use the ward id directly and do not need to join on the ward table to look up the name, but if I say &quot;the Green party&quot; then you do need to join on the party table to look up the name instead of hard-coding the party id.</p>
<h2><a class="header" href="#elections" id="elections">Elections</a></h2>
<p><img src="databases/3/../img/elections.png" alt="elections ER diagram" /></p>
<ol>
<li>How many votes were cast in all of Bristol in the 2014 elections?</li>
<li>How many votes were cast in the 'Windmill Hill' ward and what percentage of the electorate in this ward does this represent? Your statement should produce a table with one row and two columns called 'votes' and 'percentage'.</li>
<li>List the names, parties and <em>percentage</em> of votes obtained for all candidates in the Southville ward. Order the candidates by percentage of votes obtained descending.</li>
<li>How successful (in % of votes cast) was the Conservative party in each ward?</li>
<li>Which rank did Labour end up in the 'Whitchurch Park' ward? Your statement should produce a table with a single row and column containing the answer as a number. You can assume no ties.</li>
<li>What is the total number of votes that each party got in the elections? Your result should be a table with two columns party, votes.</li>
<li>Find all wards where the Green party beat Labour and create a table with two columns ward, difference where the difference column is the number of Green votes minus the number of Labour votes. Your table should be ordered by difference, with the highest one first.</li>
</ol>
<h2><a class="header" href="#census" id="census">Census</a></h2>
<p><img src="databases/3/../img/census.png" alt="census ER diagram" /></p>
<ol>
<li>How many <em>women</em> work in sales and customer service occupations and live in the Cabot ward of Bristol (E05001979)?</li>
<li>How many <em>people</em> work in sales and customer service occupations and live in the Cabot ward of Bristol (E05001979)?</li>
<li>How many people work in caring, leisure and other service occupations (occupation class 6) in all of the City of Bristol CLU (E06000023)? </li>
<li>In the Cabot ward (E05001979), produce a table listing the names of the 9 occupation classes and the number of people in each of the classes in this ward.</li>
<li>Find the working population, ward name and CLU name for the smallest ward (by working population) in the 2011 census.</li>
<li>The same as the last question, but now produce a table with two rows, one for the smallest and one for the largest ward. There's no quicker way than repeating the last query twice, the question is how to stick the two &quot;copies&quot; together.</li>
<li>Find the average size of a ward's working population in the London (E12000007) region.</li>
<li>The same as the last question but now for every region - your query should produce a table with one row per region. The intention here is <em>not</em> to repeat the above query 9 times.</li>
<li>Produce a table that lists, for each of the 9 regions of England, the percentage of people in managerial (class 1) occupations who are women.</li>
<li>For all CLUs in the London (E12000007) region, produce a table with three columns called <code>CLU</code>, <code>occupation</code> and <code>count</code> such that:
<ul>
<li><code>CLU</code> is the CLU name.</li>
<li><code>count</code> is the number of people of the occupation class in question in the given CLU.</li>
<li><code>occupation</code> is the name of the occupation class.</li>
<li>Only rows with <code>count &gt;= 10000</code> appear in the table.</li>
<li>The table is sorted by <code>count</code> ascending.</li>
</ul>
</li>
<li>Create a table with three columns <code>occupation</code>, <code>women</code> and <code>men</code> and one row per occupation class. The <code>occupation</code> column should list the occupation class names. The <code>women</code> and <code>men</code> columns in each row should list the total number of women resp. men in the row's occupation class in the whole dataset. The intention here is not to have to copy-paste a subquery 9 times.</li>
<li>The same as question 9, but now with a 10th row in the table listing the value for all of England. You can use the string <code>'England'</code> for the region column.</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
